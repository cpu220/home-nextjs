name: 构建和部署 # GitHub Actions 工作流名称

on:
  push:
    branches:
      - main # 当推送到main分支时触发工作流

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # 使用Ubuntu操作系统作为运行环境
    steps:
      - name: 检出代码 # 步骤1：从仓库检出代码
        uses: actions/checkout@v3
        with:
          persist-credentials: false # 不保留凭据

      - name: 步骤1 - 检查目录并初始化Git仓库
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "=== 开始部署步骤1 - 检查目录并初始化Git仓库 ==="
            
            # 项目路径
            PROJECT_DIR="/www/wwwroot/html/home-test"
            
            # 检查并创建目录
            [ ! -d "$PROJECT_DIR" ] && mkdir -p "$PROJECT_DIR"
            echo "项目目录: $PROJECT_DIR"
            
            # 进入项目目录
            cd "$PROJECT_DIR"
            
            # 初始化Git仓库（如果不存在）
            if [ ! -d ".git" ]; then
              echo "初始化Git仓库..."
              git init
              git config user.name "GitHub Actions"
              git config user.email "actions@github.com"
              git remote add origin https://github.com/${{ github.repository }}.git
              git config --global credential.helper 'cache --timeout=3600'
            else
              echo "更新远程仓库配置..."
              git remote set-url origin https://github.com/${{ github.repository }}.git
            fi
            
            echo "=== 步骤1 - 已完成 ==="

      - name: 步骤2 - 从远程仓库拉取最新代码
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "=== 开始部署步骤2 - 从远程仓库拉取最新代码 ==="
            
            PROJECT_DIR="/www/wwwroot/html/home-test"
            CURRENT_BRANCH="${{ github.ref_name }}"
            REPO_URL="https://github.com/${{ github.repository }}.git"
            REPO_NAME="${{ github.repository }}"
            REPO_SHORT_NAME="${REPO_NAME##*/}"
            
            # 准备目录
            cd "$(dirname "$PROJECT_DIR")"
            rm -rf "$PROJECT_DIR" 
            mkdir -p "$PROJECT_DIR"
            
            echo "尝试获取代码..."
            
            # 方法1：使用HTTPS克隆当前分支
            if git clone --depth 1 --single-branch --branch "$CURRENT_BRANCH" "$REPO_URL" "$PROJECT_DIR"; then
              echo "✓ 成功：使用HTTPS克隆当前分支"
            # 方法2：使用GitHub Actions token
            elif git clone --depth 1 --single-branch --branch "$CURRENT_BRANCH" "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${REPO_NAME}.git" "$PROJECT_DIR"; then
              echo "✓ 成功：使用GitHub Actions token"
            # 方法3：克隆main分支
            elif git clone --depth 1 --single-branch --branch main "$REPO_URL" "$PROJECT_DIR"; then
              echo "✓ 成功：克隆main分支"
            # 方法4：克隆master分支
            elif git clone --depth 1 --single-branch --branch master "$REPO_URL" "$PROJECT_DIR"; then
              echo "✓ 成功：克隆master分支"
            # 方法5：下载main分支压缩包
            elif cd "$PROJECT_DIR" && wget -q "https://github.com/${REPO_NAME}/archive/refs/heads/main.zip" -O main.zip; then
              echo "✓ 成功：下载main分支压缩包"
              unzip -q main.zip && rm main.zip
              [ -d "${REPO_SHORT_NAME}-main" ] && mv "${REPO_SHORT_NAME}-main"/* . && rmdir "${REPO_SHORT_NAME}-main"
            # 方法6：下载master分支压缩包
            elif cd "$PROJECT_DIR" && wget -q "https://github.com/${REPO_NAME}/archive/refs/heads/master.zip" -O master.zip; then
              echo "✓ 成功：下载master分支压缩包"
              unzip -q master.zip && rm master.zip
              [ -d "${REPO_SHORT_NAME}-master" ] && mv "${REPO_SHORT_NAME}-master"/* . && rmdir "${REPO_SHORT_NAME}-master"
            else
              echo "✗ 错误：无法获取代码！"
              exit 1
            fi
            
            # 进入目录并检查内容
            cd "$PROJECT_DIR"
            echo "目录内容："
            ls -la
            
            # 调整目录结构（如果需要）
            if [ ! -f "package.json" ]; then
              echo "尝试修复目录结构..."
              subdir=$(find . -maxdepth 1 -type d -not -name "node_modules" -not -name ".git" -not -name "." | head -1)
              [ -n "$subdir" ] && mv "$subdir"/* . 2>/dev/null && rmdir "$subdir" 2>/dev/null
            fi
            
            [ -f "package.json" ] && echo "✓ 找到package.json文件" || echo "! 未找到package.json文件"
            
            echo "=== 步骤2 - 已完成 ==="

      - name: 步骤3 - 安装项目依赖
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "=== 开始部署步骤3 - 安装项目依赖 ==="
            
            PROJECT_DIR="/www/wwwroot/html/home-test"
            cd "$PROJECT_DIR"
            
            echo "检查package.json文件..."
            ls -la
            
            # 确定使用的包管理器
            USE_NPM=false
            if ! command -v pnpm &> /dev/null; then
              echo "pnpm不可用，尝试安装..."
              npm install -g pnpm 2>/dev/null || {
                echo "✓ 使用npm安装依赖"
                USE_NPM=true
              }
            fi
            [ "$USE_NPM" = false ] && echo "✓ 使用pnpm安装依赖"
            
            # 查找package.json位置
            if [ ! -f "package.json" ]; then
              echo "当前目录未找到package.json，正在查找..."
              PKG_PATH=$(find . -name "package.json" -type f 2>/dev/null | head -1)
              
              if [ -z "$PKG_PATH" ]; then
                echo "✗ 错误：无法找到package.json文件！"
                exit 1
              fi
              
              cd "$(dirname "$PKG_PATH")"
              echo "✓ 在 $(pwd) 目录找到package.json"
            fi
            
            # 安装依赖
            echo "开始安装依赖..."
            if [ "$USE_NPM" = true ]; then
              npm install --verbose
            else
              pnpm install --verbose
            fi
            
            # 验证安装结果
            if [ $? -eq 0 ]; then
              echo "✓ 依赖安装成功"
            else
              echo "✗ 依赖安装失败"
              exit 1
            fi
            
            echo "=== 步骤3 - 已完成 ==="

      - name: 步骤4 - 构建项目
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "=== 开始部署步骤4 - 构建项目 ==="
            
            PROJECT_DIR="/www/wwwroot/html/home-test"
            cd "$PROJECT_DIR"
            
            # 查找并切换到包含package.json的目录
            if [ ! -f "package.json" ]; then
              echo "当前目录未找到package.json，正在查找..."
              PKG_PATH=$(find . -name "package.json" -type f 2>/dev/null | head -1)
              
              if [ -z "$PKG_PATH" ]; then
                echo "✗ 错误：无法找到package.json文件！"
                exit 1
              fi
              
              cd "$(dirname "$PKG_PATH")"
              echo "✓ 在 $(pwd) 目录找到package.json"
            fi
            
            # 执行构建
            echo "开始构建项目..."
            
            # 优先使用pnpm，如果失败则回退到npm
            if command -v pnpm &> /dev/null; then
              echo "使用pnpm构建..."
              if pnpm run build --verbose; then
                echo "✓ pnpm构建成功"
              else
                echo "尝试使用npm构建..."
                if npm run build --verbose; then
                  echo "✓ npm构建成功"
                else
                  echo "✗ 构建失败！"
                  exit 1
                fi
              fi
            else
              echo "使用npm构建..."
              if npm run build --verbose; then
                echo "✓ npm构建成功"
              else
                echo "✗ 构建失败！"
                exit 1
              fi
            fi
            
            echo "=== 步骤4 - 已完成 ==="

      - name: 步骤5 - 使用PM2重启应用
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "=== 开始部署步骤5 - 使用PM2重启应用 ==="
            
            PROJECT_DIR="/www/wwwroot/html/home-test"
            cd "$PROJECT_DIR"
            
            # 检查PM2进程是否存在，不存在则创建
            echo "正在检查PM2进程状态..."
            pm2 list | grep -q "dapangmao"
            if [ $? -ne 0 ]; then
              echo "PM2进程'dapangmao'不存在，正在创建新进程..."
              pm2 start npm --name "dapangmao" -- start
            else
              echo "PM2进程'dapangmao'已存在，正在重启..."
              pm2 restart dapangmao
            fi
            
            # 显示PM2进程状态
            pm2 status dapangmao
            
            echo "=== 步骤5 - 已完成 ==="
            echo "=== 部署过程已成功完成 ==="

