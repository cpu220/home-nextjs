name: Build and Deploy # 为GitHub Actions工作流命名

on:
  push:
    branches:
      - main # 当推送到main分支时触发工作流

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # 使用Ubuntu操作系统作为运行环境

    steps:
      - name: Checkout # 步骤1：从仓库检出代码
        uses: actions/checkout@v3
        with:
          persist-credentials: true # 保留凭据
          fetch-depth: 0

      - name: Build and Deploy # 步骤2：构建和部署
        uses: appleboy/ssh-action@master # 使用SSH Action插件
        with:
          host: ${{ secrets.SERVER_HOST }} # 从GitHub Secrets中获取服务器主机名
          username: ${{ secrets.SERVER_USERNAME }} # 从GitHub Secrets中获取服务器用户名
          password: ${{ secrets.SERVER_PASSWORD }} # 从GitHub Secrets中获取服务器密码
          port: ${{ secrets.SERVER_PORT }} # 从GitHub Secrets中获取服务器端口号
          script: |
            # 定义日志函数，添加时间戳
            log() {
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
            }
            
            # 清理函数，确保临时文件被删除
            cleanup() {
              log "执行清理..."
              if [ -f "package.json.bak" ]; then
                rm -f package.json.bak
                log "删除临时文件: package.json.bak"
              fi
            }
            
            # 捕获退出信号，执行清理
            trap cleanup EXIT
            
            log "开始部署流程"
            
            # 设置部署目录
            DEPLOY_DIR="/www/wwwroot/html/home-test"
            
            log "检查部署目录: $DEPLOY_DIR"
            if [ ! -d "$DEPLOY_DIR" ]; then
              log "部署目录不存在，创建目录"
              mkdir -p "$DEPLOY_DIR" || { log "错误: 无法创建目录"; exit 1; }
            fi
            
            cd "$DEPLOY_DIR" || { log "错误: 无法进入目录"; exit 1; }
            log "已进入部署目录"
            
            # 配置Git安全目录以解决权限检查问题
            log "配置Git安全目录以避免权限问题"
            git config --global --add safe.directory "$DEPLOY_DIR"
            
            # 检查是否是Git仓库并获取代码
            if [ ! -d ".git" ]; then
              log "当前目录不是Git仓库，开始克隆代码"
              # 确保目录为空
              find . -maxdepth 1 ! -name '.' -exec rm -rf {} \; 2>/dev/null || true
              
              # 检查GitHub Token是否存在
              if [ -z "${{ secrets.GITHUB_TOKEN }}" ]; then
                log "警告: GITHUB_TOKEN未设置，尝试使用SSH密钥或手动配置PAT"
                # 尝试使用原始URL但添加更详细的错误处理
                git clone https://github.com/${{ github.repository }} . || {
                  log "错误: Git克隆失败，无法进行身份验证"
                  log "请检查:"
                  log "1. 确保仓库允许公共访问，或"
                  log "2. 在GitHub仓库Settings > Secrets中添加正确配置的PAT"
                  log "3. 确保Token具有repo权限"
                  exit 1
                }
              else
                # 使用GitHub Token进行身份验证克隆代码
                GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
                git clone https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} . || {
                  log "错误: Git克隆失败，Token认证问题"
                  log "故障排除:"
                  log "- 检查GITHUB_TOKEN权限配置"
                  log "- 确保workflow权限设置为可读取仓库"
                  log "- 对于私有仓库，可能需要配置专用PAT"
                  exit 1
                }
              fi
              log "代码克隆成功"
            else
              log "当前目录是Git仓库，执行git pull (带超时和非交互模式)"
              # 配置Git避免交互提示
              git config --global core.askpass "echo"
              git config --global push.default simple
              git config --global pull.rebase false
              
              # 使用timeout命令设置30秒超时，添加详细日志和非交互模式参数
              log "获取远程仓库状态"
              git remote update -v
              
              log "执行git pull (超时30秒，快进模式，详细输出)"
              timeout 30s git pull --ff-only --no-edit -v || {
                local EXIT_CODE=$?
                if [ $EXIT_CODE -eq 124 ]; then
                  log "错误: Git pull超时（30秒）"
                  log "超时故障排除:"
                  log "1. 检查网络连接稳定性"
                  log "2. 尝试增加超时时间"
                else
                  log "错误: Git pull失败 (退出码: $EXIT_CODE)"
                fi
                log "Git操作故障排除:"
                log "1. 检查远程仓库是否可访问"
                log "2. 确认本地分支与远程分支同步"
                log "3. 权限问题解决:"
                log "   - 已配置safe.directory，但如仍有问题可检查目录所有者"
                log "   - 可能需要: chown -R [当前用户] $DEPLOY_DIR"
                log "4. 备选方案:"
                log "   - 可尝试删除.git目录重新克隆: rm -rf .git"
                log "   - 或执行 git reset --hard && git clean -dfx 清理本地修改"
                log "5. 强制更新选项（在紧急情况下）:"
                log "   - git fetch --all"
                log "   - git reset --hard origin/[branch_name]"
                exit 1
              }
              log "代码更新成功"
            fi
            
            # 确保package.json存在再执行npm命令
            if [ -f "package.json" ]; then
              log "检测到package.json，开始安装依赖"
              
              # 检查Node.js和npm版本
              log "检查Node.js和npm版本兼容性"
              NODE_VERSION=$(node -v)
              NPM_VERSION=$(npm -v)
              log "当前环境: Node.js $NODE_VERSION, npm $NPM_VERSION"
              
              # 备份package.json以确保安全
              cp package.json package.json.bak || { log "错误: 无法备份package.json"; exit 1; }
              
              # 验证package.json的完整性和格式（使用通用方法）
              log "验证package.json的JSON格式和完整性"
              if command -v jq > /dev/null; then
                if ! cat package.json | jq empty 2> /dev/null; then
                  log "警告: package.json格式验证失败，但继续部署"
                  log "在部署后请检查package.json的完整性"
                fi
              else
                # 使用grep简单检查关键结构
                log "使用基本检查验证package.json结构"
                if ! grep -q '"scripts"' package.json || ! grep -q '"dependencies"' package.json; then
                  log "警告: package.json缺少关键结构，但继续部署"
                fi
              fi
              
              # 设置环境变量避免执行任何脚本
              export npm_config_ignore_scripts=true
              
              # 安全安装依赖，使用多种选项确保脚本不被执行
              log "安装npm依赖（跳过所有scripts）"
              
              # 对于Node.js 20+和npm 10+版本，添加特定优化
              log "为Node.js 20+和npm 10+优化安装配置"
              
              # 清理npm缓存避免版本冲突问题
              log "清理npm缓存"
              npm cache clean --force || log "注意: 缓存清理非关键步骤，继续执行"
              
              # 检查是否存在package-lock.json或npm-shrinkwrap.json
              if [ -f "package-lock.json" ] || [ -f "npm-shrinkwrap.json" ]; then
                # 使用npm ci进行更严格的依赖安装
                log "检测到锁文件，使用npm ci安装依赖"
                npm ci --ignore-scripts --no-audit --prefer-offline --loglevel=error --legacy-peer-deps || { 
                  log "错误: npm ci失败，尝试使用npm install作为备选方案"
                  npm install --ignore-scripts --no-audit --prefer-offline --loglevel=error --legacy-peer-deps || { 
                    log "错误: npm install也失败"
                    log "依赖安装故障排除建议:"
                    log "1. 确保package.json格式正确且依赖版本兼容"
                    log "2. 检查网络连接是否正常"
                    log "3. 执行了npm缓存清理，请检查Node.js 20.19.5和npm 10.8.2的兼容性"
                    log "4. 可能需要更新package.json中的依赖版本以兼容最新Node.js环境"
                    exit 1;
                  }
                }
              else
                # 没有锁文件，使用npm install
                log "未检测到package-lock.json，使用npm install安装依赖"
                log "提示: 为了获得一致的依赖版本，建议在开发环境运行npm install生成package-lock.json"
                npm install --ignore-scripts --no-audit --prefer-offline --loglevel=error --legacy-peer-deps || { 
                  log "错误: npm install失败"
                  log "依赖安装故障排除建议:"
                  log "1. 确保package.json格式正确且依赖版本兼容"
                  log "2. 检查网络连接是否正常"
                  log "3. 已执行npm缓存清理，请检查Node.js 20.19.5和npm 10.8.2的兼容性"
                  log "4. 可能需要更新package.json中的依赖版本以兼容最新Node.js环境"
                  exit 1;
                }
              fi
              log "依赖安装成功"
              
              # 恢复原始的package.json（确保脚本和依赖不丢失）
              if [ -f "package.json.bak" ]; then
                log "恢复原始的package.json文件，确保完整配置不丢失"
                cp package.json.bak package.json || { 
                  log "警告: 无法恢复package.json，但继续部署"; 
                  # 即使恢复失败也要保留备份文件以便后续检查
                  rm -f package.json.bak || true
                }
              fi
              
              # 使用NODE_ENV=production确保生产环境构建
              log "开始生产环境构建"
              # 添加--max-old-space-size避免内存问题，特别适用于Node.js 20+环境
              NODE_ENV=production NODE_OPTIONS="--max-old-space-size=4096" npm run build --no-progress || { 
                log "错误: 构建失败"
                log "构建故障排除:"
                log "1. Node.js 20+可能需要更多内存资源"
                log "2. 检查是否有TypeScript编译错误"
                log "3. 验证项目依赖是否与Next.js 14兼容"
                exit 1;
              }
              log "构建成功完成"
            else
              log "错误: package.json not found"
              exit 1
            fi
            
            # 重启应用
            log "重启应用服务"
            pm2 restart dapangmao --interpreter none -- start || { log "警告: 应用重启可能失败，请检查PM2状态"; }
            log "部署流程完成"

