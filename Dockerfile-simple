# 简单的Next.js Dockerfile - 使用pnpm作为包管理器

# 构建阶段
FROM node:22.3.0-alpine AS builder

# 设置工作目录
WORKDIR /app

# 安装pnpm
    RUN npm install -g pnpm@8.15.0

# 设置pnpm配置
RUN pnpm config set store-dir /pnpm-store && pnpm config set registry https://registry.npmmirror.com

# 复制package.json和pnpm-lock.yaml
COPY package.json pnpm-lock.yaml* ./

# 使用pnpm安装依赖，设置合理的超时，并强制更新锁文件
    RUN pnpm install --no-optional --fetch-timeout=120000 --force

# 复制项目文件
COPY . .

# 构建项目
RUN pnpm run build

# 使用缓存卷以提高构建效率
VOLUME ["/pnpm-store"]

# 运行阶段
FROM node:22.3.0-alpine AS runner

# 设置环境变量
ENV NODE_ENV production
# PORT will be set from .env file at runtime

# 创建非root用户
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# 设置工作目录
WORKDIR /app

# 复制构建产物
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
# 复制public目录，确保静态资源（如图片）被包含
COPY --from=builder --chown=nextjs:nodejs /app/public ./public
# 创建home-static目录并复制public目录的内容，以支持带前缀的静态资源访问
RUN mkdir -p ./public/home-static && cp -r ./public/* ./public/home-static/ 2>/dev/null || true
# 复制data目录，确保portfolio.json等数据文件被包含
COPY --from=builder --chown=nextjs:nodejs /app/data ./data

# 切换到非root用户
USER nextjs

# 暴露端口
EXPOSE ${PORT:-3001}

# 启动应用
CMD ["node", "server.js"]
